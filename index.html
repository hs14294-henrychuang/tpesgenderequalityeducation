<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº«é«”é­”æ³•é˜²è­·ç½© | é­”æ³•èº«é«”å­¸é™¢</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts (Noto Sans TC for Traditional Chinese) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

    <!-- 
      UPDATES:
      1. Level 4: Voice Recognition implemented using Web Speech API.
      2. Level 4: Expanded Trust Circle options (more negative options).
      3. Home: Added API Key input field for deployment configuration.
    -->

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FFFBEB; /* amber-50 */
            touch-action: manipulation; /* Improves touch response */
        }
        
        .emoji-avatar {
            font-size: 8rem;
            line-height: 1;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        /* Canvas Container Styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 300px; /* Adjusted for layout */
            margin-left: auto;
            margin-right: auto;
            height: 200px;
            max-height: 200px;
        }

        /* Animation Classes */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .pulse-btn { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }

        .shield-glow { box-shadow: 0 0 60px 30px rgba(251, 191, 36, 0.6); border: 4px solid #F59E0B; border-radius: 50%; }

        .story-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            min-height: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* Trust Selection Grid */
        .trust-item.selected {
            background-color: #D1FAE5; /* emerald-100 */
            border-color: #10B981; /* emerald-500 */
            transform: scale(1.05);
        }
        .trust-item.wrong-choice {
            animation: shake 0.5s;
            border-color: #EF4444; /* red-500 */
            background-color: #FEE2E2;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Microphone Animation */
        .mic-listening {
            animation: mic-pulse 1.5s infinite;
            background-color: #F43F5E;
        }
        @keyframes mic-pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 0 15px rgba(244, 63, 94, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(244, 63, 94, 0); transform: scale(1); }
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Header / Progress -->
    <header class="bg-white shadow-sm p-4 z-10">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ°</span>
                <h1 class="text-lg md:text-xl font-bold text-amber-600">é­”æ³•èº«é«”å­¸é™¢</h1>
            </div>
            <div class="flex items-center gap-1">
                <div id="progress-dots" class="flex gap-2">
                    <!-- Dots generated by JS -->
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-grow overflow-y-auto relative w-full max-w-4xl mx-auto p-4 md:p-6">
        
        <!-- Welcome Screen -->
        <div id="view-intro" class="view-section flex flex-col items-center justify-center h-full text-center fade-in">
            <div class="text-6xl mb-6 bounce">ğŸ“</div>
            <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">æ­¡è¿ä¾†åˆ°<br><span class="text-amber-500">é­”æ³•èº«é«”å­¸é™¢</span></h2>
            <p class="text-lg text-gray-600 mb-8 max-w-md">æˆ‘æ˜¯é­”æ³•å­¸é™¢æ ¡é•·ã€‚åœ¨é€™è£¡ï¼Œæˆ‘å€‘è¦å­¸ç¿’å¦‚ä½•ç•¶ä¸€å€‹å‹‡æ•¢çš„ã€Œèº«é«”å°ä¸»äººã€ï¼æº–å‚™å¥½é–‹å§‹å†’éšªäº†å—ï¼Ÿ</p>
            
            <button onclick="navTo(1)" class="pulse-btn bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 px-10 rounded-full text-xl transition-transform transform hover:scale-105 shadow-lg flex items-center gap-2 mb-8">
                é–‹å§‹å†’éšª ğŸš€
            </button>

            <!-- API Key Input Section (Collapsible/Discrete) -->
            <div class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200 text-sm w-full max-w-xs">
                <label for="api-key" class="block text-gray-500 mb-1 text-left font-bold">âš™ï¸ æ•™å¸«/é–‹ç™¼è€…è¨­å®š (API Key)</label>
                <input type="password" id="api-key" placeholder="è¼¸å…¥ API Key (é¸å¡«)" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-amber-500" onchange="saveApiKey(this.value)">
                <p class="text-xs text-gray-400 mt-1 text-left">*ç”¨æ–¼æ“´å…… AI åŠŸèƒ½ã€‚æœ¬æ©ŸèªéŸ³è¾¨è­˜ç„¡éœ€å¡«å¯«ã€‚</p>
            </div>
        </div>

        <!-- Level 1: My Body, My Rules (Canvas Drawing) -->
        <div id="view-1" class="view-section hidden h-full flex flex-col fade-in">
            <div class="mb-4">
                <h3 class="text-2xl font-bold text-amber-600 mb-2">ç¬¬ä¸€é—œï¼šæˆ‘æ˜¯èº«é«”å°ä¸»äºº</h3>
                <p class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-amber-400 text-sm md:text-base">
                    <span class="text-xl mr-2">ğŸ“¢</span>
                    <span class="italic text-gray-600">å°å¸«å»£æ’­ï¼š</span> 
                    é€™æ˜¯ä½ çš„èº«é«”ã€‚è«‹ç”¨æ‰‹æŒ‡åœ¨ã€Œå…¨èº«ã€å‘¨åœç•«ä¸€å€‹å¤§åœˆåœˆï¼Œå•Ÿå‹•ä½ çš„ã€Œå…¨èº«é˜²è­·ç½©ã€ï¼
                </p>
            </div>
            
            <div class="flex-grow flex flex-col items-center justify-center relative bg-white rounded-2xl shadow-inner border-2 border-dashed border-gray-300 m-2 overflow-hidden touch-none" id="canvas-wrapper">
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                    <span class="emoji-avatar" id="avatar-target">ğŸ§</span>
                </div>
                <canvas id="shieldCanvas" class="absolute inset-0 z-10 cursor-crosshair"></canvas>
                
                <div id="shield-success-msg" class="hidden absolute top-4 bg-emerald-100 text-emerald-700 px-4 py-2 rounded-full font-bold shadow-lg z-20 animate-bounce">
                    âœ¨ å…¨èº«é˜²è­·ç½©å•Ÿå‹•æˆåŠŸï¼ âœ¨
                </div>
            </div>

            <div class="mt-4 flex justify-between items-center">
                <button onclick="clearCanvas()" class="text-gray-500 underline text-sm">é‡ç•«ä¸€æ¬¡</button>
                <button id="btn-next-1" disabled onclick="navTo(2)" class="bg-gray-300 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 opacity-50 cursor-not-allowed">
                    å¸¶è‘—é˜²è­·ç½©å‡ºç™¼ ğŸ›¡ï¸
                </button>
            </div>
        </div>

        <!-- Level 2: Feeling Radar (Sorting Game) -->
        <div id="view-2" class="view-section hidden h-full flex flex-col fade-in">
            <div class="mb-4">
                <h3 class="text-2xl font-bold text-emerald-600 mb-2">ç¬¬äºŒé—œï¼šæ„Ÿè¦ºé›·é”å—¶å—¶å—¶</h3>
                <p class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-emerald-400 text-sm md:text-base">
                    <span class="text-xl mr-2">ğŸ“¡</span>
                    <span class="italic text-gray-600">å°å¸«å»£æ’­ï¼š</span>
                    é‡åˆ°ä¸åŒçš„æ¥è§¸æ™‚ï¼Œå¿ƒè£¡çš„æ„Ÿè¦ºå°±æ˜¯ä½ çš„é›·é”ã€‚å…±æœ‰ 10 é¡Œï¼ŒåŠ æ²¹ï¼
                </p>
            </div>

            <div class="flex-grow flex flex-col gap-4">
                <div class="grid grid-cols-2 gap-4 h-1/3">
                    <div class="bg-green-100 border-2 border-green-300 rounded-xl flex flex-col items-center justify-center p-2 text-center transition-colors" id="zone-good">
                        <span class="text-4xl mb-1">ğŸ˜Š</span>
                        <span class="font-bold text-green-800">ç¶ ç‡ˆ (å¯ä»¥)</span>
                    </div>
                    <div class="bg-red-100 border-2 border-red-300 rounded-xl flex flex-col items-center justify-center p-2 text-center transition-colors" id="zone-bad">
                        <span class="text-4xl mb-1">ğŸš¨</span>
                        <span class="font-bold text-red-800">ç´…ç‡ˆ (ä¸è¡Œ)</span>
                    </div>
                </div>

                <div class="flex-grow bg-slate-50 rounded-xl p-4 flex flex-col items-center justify-center relative">
                    <div id="current-card" class="bg-white w-64 h-48 shadow-xl rounded-2xl flex flex-col items-center justify-center border border-gray-200 transform transition-transform cursor-pointer hover:scale-105 z-10 px-4 text-center">
                        <span class="text-5xl mb-4" id="card-emoji">â“</span>
                        <p class="font-bold text-lg leading-tight" id="card-text">æº–å‚™å¥½äº†å—ï¼Ÿ</p>
                        <p class="text-xs text-gray-400 mt-4" id="card-progress">(1/10)</p>
                    </div>
                    
                    <div class="flex gap-4 mt-6 w-full max-w-sm justify-center">
                        <button onclick="sortCard('bad')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold shadow-md">âŒ è¦ºå¾—æ€ªæ€ªçš„</button>
                        <button onclick="sortCard('good')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-md">â­• è¦ºå¾—å¯ä»¥</button>
                    </div>
                </div>
            </div>

            <div id="radar-feedback" class="mt-2 text-center h-6 text-sm font-bold text-amber-600"></div>

             <div class="mt-4 flex justify-end">
                <button id="btn-next-2" disabled onclick="navTo(3)" class="bg-gray-300 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 opacity-50 cursor-not-allowed">
                    é–‹å•Ÿæ•…äº‹æ›¸ ğŸ“–
                </button>
            </div>
        </div>

        <!-- Level 3: Story Time (Interactive Story) -->
        <div id="view-3" class="view-section hidden h-full flex flex-col fade-in">
            <div class="mb-2">
                <h3 class="text-2xl font-bold text-indigo-600">ç¬¬ä¸‰é—œï¼šå°æ¾é¼ çš„å‹‡æ•¢ä»»å‹™</h3>
            </div>

            <div class="flex-grow flex items-center justify-center p-2">
                <div class="story-card w-full max-w-3xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-3 bg-gray-100">
                        <div id="story-progress" class="h-full bg-indigo-500 transition-all duration-500" style="width: 10%"></div>
                    </div>

                    <div id="story-scene" class="flex flex-col items-center w-full fade-in py-4">
                        <div class="text-9xl mb-6 relative h-40 flex items-end justify-center">
                            <span id="story-visual-main">ğŸ¿ï¸</span>
                            <span id="story-visual-sub" class="absolute -right-4 bottom-0 text-7xl transition-all duration-500"></span>
                        </div>
                        <p id="story-text" class="text-xl md:text-2xl font-medium text-gray-800 leading-relaxed mb-8 max-w-2xl">
                            å°æ¾é¼ åœ¨å…¬åœ’å¿«æ¨‚åœ°ç©è€...
                        </p>
                        
                        <button onclick="playAudioNarrator()" class="flex items-center gap-2 text-indigo-500 bg-indigo-50 px-4 py-2 rounded-full text-base hover:bg-indigo-100 mb-6">
                            <span>ğŸ”Š</span> è½è½æ•…äº‹
                        </button>

                        <div id="story-choices" class="hidden flex-col gap-4 w-full max-w-md"></div>
                        
                        <button id="story-next-btn" onclick="nextStoryScene()" class="bg-indigo-500 text-white px-10 py-3 text-lg rounded-full hover:bg-indigo-600 shadow-md">
                            ä¸‹ä¸€é  â¡ï¸
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-4 flex justify-end">
                <button id="btn-next-3" disabled onclick="navTo(4)" class="hidden bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">
                    é ˜å–å‹‡æ°£å¾½ç«  ğŸ…
                </button>
            </div>
        </div>

        <!-- Level 4: Action Squad (Voice & Trust) -->
        <div id="view-4" class="view-section hidden h-full flex flex-col fade-in">
            <div class="mb-2">
                <h3 class="text-2xl font-bold text-rose-600">ç¬¬å››é—œï¼šé˜²è­·ç½©è¯ç›Ÿé›†åˆï¼</h3>
                <p class="text-gray-600 text-sm">å£è¨£ï¼šå¤§è²èªªä¸ã€è¶•å¿«é›¢é–‹ã€å‘Šè¨´å¤§äºº</p>
            </div>

            <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto">
                
                <!-- Action 1: Voice Recognition (Updated) -->
                <div class="bg-white rounded-xl shadow-sm p-4 flex flex-col items-center justify-between">
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">1. ç·´ç¿’å¤§è²èªªå‡ºå£ï¼</h4>
                        <p class="text-xs text-gray-500 mb-2">æŒ‰ä¸‹éº¥å…‹é¢¨ï¼Œå¤§è²èªªï¼š<br><span class="font-bold text-rose-500 text-base">ã€Œæˆ‘ä¸å–œæ­¡ï¼ã€</span> æˆ– <span class="font-bold text-rose-500 text-base">ã€Œä¸è¦ç¢°æˆ‘ï¼ã€</span></p>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="courageChart"></canvas>
                        <div id="no-overlay" class="hidden absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="text-6xl font-black text-rose-600 bg-white/80 rounded-full p-4 border-4 border-rose-600 transform -rotate-12">NO!</span>
                        </div>
                    </div>

                    <div class="flex flex-col items-center w-full">
                        <button id="mic-btn" onclick="toggleSpeech()" class="mt-[-20px] bg-indigo-500 hover:bg-indigo-600 text-white font-bold w-20 h-20 rounded-full shadow-xl flex items-center justify-center text-4xl transition-all active:scale-95 z-10">
                            ğŸ™ï¸
                        </button>
                        <p id="speech-feedback" class="h-6 mt-2 text-sm font-bold text-indigo-600">é»æ“Šéº¥å…‹é¢¨é–‹å§‹èªªè©±...</p>
                    </div>
                </div>

                <!-- Action 2: Expanded Trust Team (Updated) -->
                <div class="bg-white rounded-xl shadow-sm p-4 flex flex-col items-center">
                    <h4 class="font-bold text-gray-700 mb-2">2. å»ºç«‹ä¿¡ä»»åœˆ</h4>
                    <p class="text-xs text-gray-500 mb-4">è«‹é¸å‡º 3 ä½çœŸæ­£å¯ä»¥ä¿¡ä»»çš„å¤§äºº</p>
                    
                    <!-- 3x3 Grid -->
                    <div class="grid grid-cols-3 gap-2 w-full">
                        <button onclick="toggleTrust(this)" class="trust-item border-2 border-gray-100 rounded-lg p-2 flex flex-col items-center hover:bg-gray-50" data-type="good">
                            <span class="text-2xl">ğŸ‘©</span><span class="text-xs font-bold">åª½åª½</span>
                        </button>
                        <button onclick="toggleTrust(this)" class="trust-item border-2 border-gray-100 rounded-lg p-2 flex flex-col items-center hover:bg-gray-50" data-type="good">
                            <span class="text-2xl">ğŸ‘¨</span><span class="text-xs font-bold">çˆ¸çˆ¸</span>
                        </button>
                        <button onclick="toggleTrust(this)" class="trust-item border-2 border-gray-100 rounded-lg p-2 flex flex-col items-center opacity-70 hover:opacity-100" data-type="bad">
                            <span class="text-2xl">ğŸ˜</span><span class="text-xs">é™Œç”Ÿäºº</span>
                        </button>
                        
                        <button onclick="toggleTrust(this)" class="trust-item border-2 border-gray-100 rounded-lg p-2 flex flex-col items-center opacity-70 hover:opacity-100" data-type="bad">
                            <span class="text-2xl">ğŸ¬</span><span class="text-xs">é€ç¦®ç‰©çš„äºº</span>
                        </button>
                        <button onclick="toggleTrust(this)" class="trust-item border-2 border-gray-100 rounded-lg p-2 flex flex-col items-center hover:bg-gray-50" data-type="good">
                            <span class="text-2xl">ğŸ‘©â€ğŸ«</span><span class="text-xs font-bold">è€å¸«</span>
                        </button>
                         <button onclick="toggleTrust(this)" class="trust-item border-2 border-gray-100 rounded-lg p-2 flex flex-col items-center opacity-70 hover:opacity-100" data-type="bad">
                            <span class="text-2xl">ğŸ’»</span><span class="text-xs">ç¶²å‹</span>
                        </button>

                        <button onclick="toggleTrust(this)" class="trust-item border-2 border-gray-100 rounded-lg p-2 flex flex-col items-center hover:bg-gray-50" data-type="good">
                            <span class="text-2xl">ğŸ‘®</span><span class="text-xs font-bold">è­¦å¯Ÿ</span>
                        </button>
                        <button onclick="toggleTrust(this)" class="trust-item border-2 border-gray-100 rounded-lg p-2 flex flex-col items-center opacity-70 hover:opacity-100" data-type="bad">
                            <span class="text-2xl">ğŸº</span><span class="text-xs">å¤§é‡ç‹¼</span>
                        </button>
                        <button onclick="toggleTrust(this)" class="trust-item border-2 border-gray-100 rounded-lg p-2 flex flex-col items-center opacity-70 hover:opacity-100" data-type="bad">
                            <span class="text-2xl">ğŸ§¢</span><span class="text-xs">å¥‡æ€ªå”å”</span>
                        </button>
                    </div>
                    <div id="trust-feedback" class="text-xs text-rose-500 mt-2 font-bold h-4"></div>
                </div>
            </div>

            <!-- Certificate (Hidden) -->
            <div id="certificate" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center p-6 text-center animate-bounce-in">
                <div class="border-8 border-double border-amber-400 p-8 rounded-xl bg-yellow-50 max-w-md w-full shadow-2xl">
                    <div class="text-6xl mb-4">ğŸ†</div>
                    <h2 class="text-3xl font-bold text-amber-600 mb-2">é˜²è­·ç½©å°éšŠé•·è­‰æ›¸</h2>
                    <p class="text-gray-700 mb-6">æ­å–œä½ ï¼ä½ å·²ç¶“å­¸æœƒä¿è­·è‡ªå·±ï¼Œ<br>ä¹ŸçŸ¥é“å¦‚ä½•å°‹æ±‚å¹«åŠ©äº†ï¼</p>
                    <div class="bg-white p-4 rounded border border-gray-200 text-left text-sm text-gray-600 mb-6">
                        <p>âœ… å…¨èº«é˜²è­·ç½©å·²å•Ÿå‹•</p>
                        <p>âœ… 10é¡Œæ„Ÿè¦ºé›·é”å…¨å°</p>
                        <p>âœ… æˆåŠŸå¤§è²èªªä¸</p>
                        <p>âœ… ä¿¡ä»»åå–®å·²å»ºç«‹</p>
                    </div>
                    <button onclick="location.reload()" class="bg-indigo-500 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-600 shadow-lg">
                        å†ç·´ç¿’ä¸€æ¬¡ ğŸ”„
                    </button>
                </div>
            </div>
            
             <div class="mt-4 flex justify-center">
                <button id="btn-finish" disabled onclick="showCertificate()" class="bg-gray-300 text-white font-bold py-3 px-12 rounded-full transition-all duration-300 opacity-50 cursor-not-allowed text-xl">
                    é ˜å–è­‰æ›¸ ğŸ“
                </button>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t p-2 text-center text-xs text-gray-400">
        æ•™æè¨­è¨ˆï¼šå­¸å‹™è™• | é©åˆå¹´é½¡ï¼šåœ‹å°ä¸‰å¹´ç´š | èº«é«”è‡ªä¸»æ¬Šæ•™è‚²
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // State
        let currentLevel = 0;
        const totalLevels = 4;
        let drawingDone = false;
        let courageChart = null;
        let courageValue = 0;
        let trustCount = 0;
        let apiKey = "";

        // API Key Handling
        function saveApiKey(key) {
            apiKey = key;
            console.log("API Key saved:", key ? "****" : "None");
            // In a real app, save to localStorage or use immediately
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            updateProgressDots();
            setupCanvas();
            setupRadarGame();
            setupStory();
            setupCourageChart();
        });

        // Navigation
        function navTo(level) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-intro').classList.add('hidden');
            
            const target = document.getElementById(`view-${level}`);
            if(target) target.classList.remove('hidden');
            
            currentLevel = level;
            updateProgressDots();
            
            if(level === 1) resizeCanvas();
            if(level === 2) loadNextCard();
        }

        function updateProgressDots() {
            const container = document.getElementById('progress-dots');
            container.innerHTML = '';
            for(let i=1; i<=totalLevels; i++) {
                const dot = document.createElement('div');
                dot.className = `w-3 h-3 rounded-full transition-colors duration-300 ${i <= currentLevel ? 'bg-amber-500' : 'bg-gray-200'}`;
                container.appendChild(dot);
            }
        }

        // --- Level 1: Canvas Logic ---
        function setupCanvas() {
            const canvas = document.getElementById('shieldCanvas');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let points = 0;

            function startDraw(e) {
                isDrawing = true;
                points = 0;
                ctx.beginPath();
                ctx.moveTo(getX(e), getY(e));
                ctx.strokeStyle = '#F59E0B'; // Amber-500
                ctx.lineWidth = 6;
                ctx.lineCap = 'round';
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                ctx.lineTo(getX(e), getY(e));
                ctx.stroke();
                points++;
                
                if(points > 60 && !drawingDone) {
                    completeDrawing();
                }
            }

            function endDraw() {
                isDrawing = false;
                ctx.beginPath();
            }

            function getX(e) { return e.type.includes('touch') ? e.touches[0].clientX - canvas.getBoundingClientRect().left : e.offsetX; }
            function getY(e) { return e.type.includes('touch') ? e.touches[0].clientY - canvas.getBoundingClientRect().top : e.offsetY; }

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('touchstart', startDraw, {passive: false});
            canvas.addEventListener('touchmove', draw, {passive: false});
            canvas.addEventListener('touchend', endDraw);
        }

        function resizeCanvas() {
            const wrapper = document.getElementById('canvas-wrapper');
            const canvas = document.getElementById('shieldCanvas');
            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;
        }

        function completeDrawing() {
            if(drawingDone) return;
            drawingDone = true;
            document.getElementById('avatar-target').parentElement.classList.add('shield-glow');
            document.getElementById('shield-success-msg').classList.remove('hidden');
            const btn = document.getElementById('btn-next-1');
            btn.disabled = false;
            btn.classList.remove('bg-gray-300', 'opacity-50', 'cursor-not-allowed');
            btn.classList.add('bg-amber-500', 'hover:bg-amber-600', 'shadow-lg', 'pulse-btn');
        }

        function clearCanvas() {
            const canvas = document.getElementById('shieldCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawingDone = false;
            document.getElementById('avatar-target').parentElement.classList.remove('shield-glow');
            document.getElementById('shield-success-msg').classList.add('hidden');
            const btn = document.getElementById('btn-next-1');
            btn.disabled = true;
            btn.classList.add('bg-gray-300', 'opacity-50', 'cursor-not-allowed');
            btn.classList.remove('bg-amber-500', 'hover:bg-amber-600', 'shadow-lg', 'pulse-btn');
        }

        // --- Level 2: Radar Logic ---
        const cards = [
            { id: 1, text: "å¥½æœ‹å‹æ“ŠæŒ", emoji: "âœ‹", type: "good" },
            { id: 2, text: "é™Œç”Ÿäººæ‘¸ä½ çš„é ­", emoji: "ğŸ‘´", type: "bad" },
            { id: 3, text: "é†«ç”Ÿæª¢æŸ¥èº«é«” (çˆ¸åª½åœ¨æ—)", emoji: "ğŸ©º", type: "good" },
            { id: 4, text: "æœ‰äººæƒ³ç¢°ä½ æ³³è¡£é®ä½çš„åœ°æ–¹", emoji: "ğŸ©±", type: "bad" },
            { id: 5, text: "éš”å£é„°å±…è¦ä½ ååœ¨ä»–è…¿ä¸Š", emoji: "ğŸ›‹ï¸", type: "bad" },
            { id: 6, text: "çˆ¸çˆ¸åª½åª½æ“æŠ±ä½ èªªæ™šå®‰", emoji: "ğŸ›Œ", type: "good" },
            { id: 7, text: "åŒå­¸æ•…æ„æ€ä½ çš„è£™å­/æ‹‰è¤²å­", emoji: "ğŸ˜¤", type: "bad" },
            { id: 8, text: "è€å¸«æ‹æ‹è‚©è†€é¼“å‹µä½ ", emoji: "ğŸ‘©â€ğŸ«", type: "good" },
            { id: 9, text: "é™Œç”Ÿäººçµ¦ä½ ç³–æœè¦ä½ è·Ÿä»–èµ°", emoji: "ğŸ¬", type: "bad" },
            { id: 10, text: "æœ‰äººå«ä½ ä¿å®ˆã€Œèº«é«”çš„ç§˜å¯†ã€", emoji: "ğŸ¤«", type: "bad" }
        ];
        let cardIndex = 0;

        function setupRadarGame() {}

        function loadNextCard() {
            if(cardIndex >= cards.length) {
                document.getElementById('current-card').innerHTML = '<span class="text-5xl mb-2">ğŸ‰</span><p class="font-bold">å…¨éƒ¨å®Œæˆï¼</p>';
                document.getElementById('radar-feedback').innerText = "é›·é”æ¸¬è©¦é€šéï¼å¤ªå²å®³äº†ï¼";
                const btn = document.getElementById('btn-next-2');
                btn.disabled = false;
                btn.classList.remove('bg-gray-300', 'opacity-50', 'cursor-not-allowed');
                btn.classList.add('bg-emerald-500', 'hover:bg-emerald-600', 'shadow-lg', 'pulse-btn');
                return;
            }
            const card = cards[cardIndex];
            document.getElementById('card-emoji').innerText = card.emoji;
            document.getElementById('card-text').innerText = card.text;
            document.getElementById('card-progress').innerText = `(${cardIndex + 1}/10)`;
            document.getElementById('radar-feedback').innerText = "";
        }

        function sortCard(choice) {
            if(cardIndex >= cards.length) return;
            const current = cards[cardIndex];
            const feedback = document.getElementById('radar-feedback');
            
            if(choice === current.type) {
                feedback.innerText = "ç­”å°äº†ï¼ä½ çš„æ„Ÿè¦ºå¾ˆæ•éŠ³ï¼âœ¨";
                feedback.className = "mt-2 text-center h-6 text-sm font-bold text-emerald-600";
                const zone = document.getElementById(choice === 'good' ? 'zone-good' : 'zone-bad');
                zone.classList.add(choice === 'good' ? 'bg-green-300' : 'bg-red-300');
                setTimeout(() => {
                    zone.classList.remove('bg-green-300', 'bg-red-300');
                    cardIndex++;
                    loadNextCard();
                }, 500);
            } else {
                if(choice === 'good') {
                    feedback.innerText = "é€™æ™‚å€™å¿ƒè£¡æ‡‰è©²æœƒè¦ºå¾—æ€ªæ€ªçš„å–”ï¼Œè¦æ³¨æ„ï¼";
                } else {
                    feedback.innerText = "é€™æ˜¯å®‰å…¨çš„æ¥è§¸ï¼Œä¸ç”¨æ“”å¿ƒå–”ï¼";
                }
                feedback.className = "mt-2 text-center h-6 text-sm font-bold text-amber-600";
            }
        }

        // --- Level 3: Story Logic ---
        const storyScenes = [
            { text: "å°æ¾é¼ åœ¨å…¬åœ’å¿«æ¨‚åœ°ç©è€ã€‚ä»Šå¤©å¤©æ°£çœŸå¥½ï¼", main: "ğŸ¿ï¸", sub: "ğŸŒ³", progress: "10%" },
            { text: "é„°å±…å¤§é‡ç‹¼å”å”èµ°éä¾†ï¼Œæ‹¿å‡ºå¾ˆå¤šäº”é¡å…­è‰²çš„ç³–æœã€‚ä»–èªªï¼šã€Œå°æ¾é¼ ï¼Œé€™äº›ç³–æœéƒ½çµ¦å¦³ï¼Œå»æˆ‘å®¶é‚„æœ‰æ›´å¥½ç©çš„é›»å‹•å–”ï¼ã€", main: "ğŸ¿ï¸", sub: "ğŸºğŸ¬", progress: "25%", isChoice: true, choiceId: "candy" },
            { text: "å°æ¾é¼ æ‹’çµ•äº†ç³–æœï¼Œç¹¼çºŒç©ã€‚ä½†æ˜¯å¤§é‡ç‹¼å”å”é å¾—å¥½è¿‘ï¼Œç”šè‡³ä¼¸æ‰‹æ‘¸å°æ¾é¼ çš„å¤§è…¿...", main: "ğŸ˜£", sub: "ğŸºğŸ¤š", progress: "45%", isChoice: true, choiceId: "touch" },
            { text: "å¤§é‡ç‹¼å”å”ç”Ÿæ°£åœ°èªªï¼šã€Œé€™æ˜¯æˆ‘å€‘çš„ç¥•å¯†ï¼Œçµ•å°ä¸èƒ½è·Ÿåª½åª½èªªå–”ï¼ä¸ç„¶æˆ‘å°±ä¸å–œæ­¡å¦³äº†ï¼ã€å°æ¾é¼ è¦ºå¾—è‚šå­ç·Šç·Šçš„ï¼Œå¾ˆä¸èˆ’æœ...", main: "ğŸ˜°", sub: "ğŸºğŸ’¢", progress: "65%", isChoice: true, choiceId: "secret" },
            { text: "å°æ¾é¼ æƒ³èµ·é­”æ³•é˜²è­·ç½©ï¼ç‰ é¼“èµ·å‹‡æ°£ï¼Œç«‹åˆ»è·‘å›å®¶å‘Šè¨´åª½åª½ï¼", main: "ğŸƒğŸ’¨", sub: "ğŸ ", progress: "85%" },
            { text: "åª½åª½æŠ±ä½å°æ¾é¼ èªªï¼šã€Œä½ å¾ˆå‹‡æ•¢ï¼ã€ç„¶å¾Œè«‹è€è™éšŠé•·(è­¦å¯Ÿ)å»è­¦å‘Šå¤§é‡ç‹¼ã€‚å£äººå—åˆ°è™•ç½°ï¼Œå°æ¾é¼ å¾ˆå®‰å…¨ï¼", main: "ğŸ‘©â€ğŸ‘¦", sub: "ğŸ‘®", progress: "100%", isEnd: true }
        ];
        let storyIndex = 0;

        function renderStory() {
            const scene = storyScenes[storyIndex];
            document.getElementById('story-text').innerText = scene.text;
            document.getElementById('story-visual-main').innerText = scene.main;
            document.getElementById('story-visual-sub').innerText = scene.sub;
            document.getElementById('story-progress').style.width = scene.progress;

            const nextBtn = document.getElementById('story-next-btn');
            const choicesContainer = document.getElementById('story-choices');

            if (scene.isChoice) {
                nextBtn.classList.add('hidden');
                choicesContainer.classList.remove('hidden');
                choicesContainer.classList.add('flex');
                
                choicesContainer.innerHTML = '';
                if(scene.choiceId === "candy") {
                    createChoiceBtn("ğŸ¬ å¥½å•Šï¼æˆ‘è¦å»ï¼", "wrong-candy");
                    createChoiceBtn("âœ‹ ä¸è¦åœ¨é€™è£¡ï¼Œæˆ‘è¦å›å®¶åƒé£¯äº†", "correct");
                } else if (scene.choiceId === "touch") {
                    createChoiceBtn("ğŸ¤ ä¸æ•¢èªªè©±...", "wrong-touch");
                    createChoiceBtn("ğŸ“¢ ä½æ‰‹ï¼æˆ‘ä¸å–œæ­¡é€™æ¨£ï¼", "correct");
                } else if (scene.choiceId === "secret") {
                    createChoiceBtn("ğŸ¤ ç­”æ‡‰ä¿å®ˆç§˜å¯†", "wrong-secret");
                    createChoiceBtn("ğŸƒâ€â™€ï¸ è·‘å›å®¶å‘Šè¨´å¤§äºº", "correct");
                }
            } else if (scene.isEnd) {
                nextBtn.classList.add('hidden');
                choicesContainer.classList.add('hidden');
                choicesContainer.classList.remove('flex');
                const finalBtn = document.getElementById('btn-next-3');
                finalBtn.classList.remove('hidden');
                finalBtn.disabled = false;
            } else {
                nextBtn.classList.remove('hidden');
                choicesContainer.classList.add('hidden');
                choicesContainer.classList.remove('flex');
            }
        }

        function createChoiceBtn(text, type) {
            const btn = document.createElement('button');
            btn.innerText = text;
            btn.className = `w-full py-4 rounded-lg text-lg font-bold shadow-md transition-transform transform hover:scale-105 ${type === 'correct' ? 'bg-indigo-500 hover:bg-indigo-600 text-white pulse-btn' : 'bg-gray-100 hover:bg-gray-200 text-gray-700 border-2 border-gray-300'}`;
            btn.onclick = () => type === 'correct' ? (storyIndex++, renderStory()) : handleWrongChoice(type);
            document.getElementById('story-choices').appendChild(btn);
        }

        function handleWrongChoice(type) {
            let msg = "";
            if(type === "wrong-candy") msg = "é™Œç”Ÿäººçš„æ±è¥¿å¯èƒ½æœ‰å±éšªï¼Œè€Œä¸”å»åˆ¥äººå®¶å¦‚æœç™¼ç”Ÿäº‹æƒ…ï¼Œçˆ¸çˆ¸åª½åª½æœƒæ‰¾ä¸åˆ°ä½ å–”ï¼";
            if(type === "wrong-touch") msg = "å¦‚æœä¸èªªå‡ºä¾†ï¼Œä»–å¯èƒ½æœƒç¹¼çºŒåšä½ ä¸å–œæ­¡çš„äº‹ã€‚å¤§è²èªªã€Œä½æ‰‹ã€èƒ½ä¿è­·è‡ªå·±ï¼";
            if(type === "wrong-secret") msg = "é€™æ™‚å€™å¿ƒè£¡æ€ªæ€ªçš„ï¼Œä¿å®ˆç§˜å¯†æœƒè®“å£äººç¹¼çºŒåšå£äº‹å–”ï¼æ‰¾å¤§äººå¹«å¿™æ¯”è¼ƒå®‰å…¨ï¼";
            alert("âš ï¸ " + msg + "\nè«‹å†è©¦ä¸€æ¬¡æ­£ç¢ºçš„é¸æ“‡ï¼");
        }

        function nextStoryScene() {
            storyIndex++;
            renderStory();
        }

        function playAudioNarrator() {
            const btn = document.querySelector('#story-scene button');
            const originalText = btn.innerHTML;
            btn.innerHTML = "ğŸ”Š æ’­æ”¾ä¸­...";
            btn.classList.add('bg-indigo-200');
            setTimeout(() => { btn.innerHTML = originalText; btn.classList.remove('bg-indigo-200'); }, 2000);
        }

        function setupStory() { renderStory(); }

        // --- Level 4: Speech Recognition & Trust ---
        let recognition = null;
        let isListening = false;

        function setupCourageChart() {
            const ctx = document.getElementById('courageChart').getContext('2d');
            courageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å‹‡æ°£å€¼', 'é‚„æ²’æ»¿'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#F43F5E', '#E5E7EB'], 
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
            setupSpeech();
        }

        function setupSpeech() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-TW'; // Traditional Chinese
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('mic-btn').classList.add('mic-listening');
                    document.getElementById('speech-feedback').innerText = "æ­£åœ¨è½ä½ èªª...";
                };

                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('mic-btn').classList.remove('mic-listening');
                    if(courageValue < 100) document.getElementById('speech-feedback').innerText = "å†è©¦ä¸€æ¬¡ï¼Œå¤§è²ä¸€é»ï¼";
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    console.log("Heard:", transcript);
                    checkSpeech(transcript);
                };

                recognition.onerror = (event) => {
                    console.error(event.error);
                    document.getElementById('speech-feedback').innerText = "éº¥å…‹é¢¨å¥½åƒæ²’è²éŸ³ï¼Ÿ(è«‹ç¢ºèªæ¬Šé™)";
                    // Fallback for non-supported/error cases: Long press simulation
                    setTimeout(() => {
                        if(confirm("éº¥å…‹é¢¨ç„¡æ³•ä½¿ç”¨ï¼Œè¦æ”¹ç”¨æŒ‰éˆ•æ¨¡æ“¬å—ï¼Ÿ")) {
                            document.getElementById('mic-btn').onclick = simulateSpeechSuccess;
                        }
                    }, 1000);
                };
            } else {
                 document.getElementById('speech-feedback').innerText = "ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³ï¼Œè«‹é»æ“ŠæŒ‰éˆ•æ¨¡æ“¬ã€‚";
                 document.getElementById('mic-btn').onclick = simulateSpeechSuccess;
            }
        }

        function toggleSpeech() {
            if(!recognition) { simulateSpeechSuccess(); return; }
            if(isListening) recognition.stop();
            else recognition.start();
        }

        function checkSpeech(text) {
            const keywords = ["ä¸", "ä¸è¦", "èµ°é–‹", "è¨å­", "ä½æ‰‹", "NO", "ä¸å–œæ­¡"];
            const matched = keywords.some(k => text.includes(k));
            
            if (matched) {
                document.getElementById('speech-feedback').innerText = `è½åˆ°äº†ï¼šã€Œ${text}ã€å¤ªæ£’äº†ï¼`;
                courageValue = 100;
                updateChart();
                document.getElementById('no-overlay').classList.remove('hidden');
                checkFinalStatus();
            } else {
                document.getElementById('speech-feedback').innerText = `è½åˆ°ï¼šã€Œ${text}ã€ï¼Œè©¦è©¦èªªã€Œä¸è¦ï¼ã€`;
            }
        }

        function simulateSpeechSuccess() {
             document.getElementById('speech-feedback').innerText = "æ¨¡æ“¬æˆåŠŸï¼(å¤§è²èªªä¸)";
             courageValue = 100;
             updateChart();
             document.getElementById('no-overlay').classList.remove('hidden');
             checkFinalStatus();
        }

        function updateChart() {
            courageChart.data.datasets[0].data = [courageValue, 100 - courageValue];
            courageChart.update();
        }

        function toggleTrust(btn) {
            const type = btn.dataset.type;
            const feedback = document.getElementById('trust-feedback');

            if(type === "bad") {
                feedback.innerText = "å“å‘€ï¼Œé€™å€‹äººå¯èƒ½ä¸å¤ªé©åˆç•¶ç·Šæ€¥é€£çµ¡äººå–”ï¼";
                btn.classList.add('wrong-choice');
                setTimeout(() => { 
                    btn.classList.remove('wrong-choice'); 
                    feedback.innerText = "";
                }, 1000);
                return;
            }

            if(btn.classList.contains('selected')) {
                btn.classList.remove('selected');
                trustCount--;
            } else {
                if(trustCount < 3) {
                    btn.classList.add('selected');
                    trustCount++;
                    feedback.innerText = "å¤ªæ£’äº†ï¼æ‰¾åˆ°ä¸€å€‹å¹«æ‰‹ï¼";
                    feedback.className = "text-xs text-emerald-500 mt-2 font-bold h-4";
                }
            }
            checkFinalStatus();
        }

        function checkFinalStatus() {
            if(courageValue >= 100 && trustCount >= 3) {
                const btn = document.getElementById('btn-finish');
                btn.disabled = false;
                btn.classList.remove('bg-gray-300', 'opacity-50', 'cursor-not-allowed');
                btn.classList.add('bg-indigo-500', 'hover:bg-indigo-600', 'shadow-lg', 'pulse-btn');
            }
        }

        function showCertificate() {
            document.getElementById('certificate').classList.remove('hidden');
        }
    </script>
</body>
</html>
